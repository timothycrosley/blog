<!DOCTYPE html>
<html lang="en-us">

<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="HandheldFriendly" content="True">

  <!-- Description -->
  <meta name="robots" content="index,follow">
  <meta name="description" content=""/>

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:site" content="@">
  <meta property="twitter:title" content="Project  1/52: preconvert - Supercharge Your Serialization! - Timothy Crosley" />
  <meta property="twitter:description" content="" />
  <meta property="twitter:image" content="" />

  <!-- Open Graph -->
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Project  1/52: preconvert - Supercharge Your Serialization! - Timothy Crosley" />
  <meta property="og:description" content="  " />
  <meta property="og:url" content="https://timothycrosley.com/project-1-preconvert" />
  <meta property="og:site_name" content="Project  1/52: preconvert - Supercharge Your Serialization! - Timothy Crosley" />
  <meta property="og:image" content="" />
  <meta property="og:image:secure_url" content="" />

  <title>
    Project  1/52: preconvert - Supercharge Your Serialization! - Timothy Crosley
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="https://timothycrosley.com/theme/css/poole.css">
  <link rel="stylesheet" href="https://timothycrosley.com/theme/css/syntax.css">
  <link rel="stylesheet" href="https://timothycrosley.com/theme/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="shortcut icon" type="image/png" href="https://timothycrosley.com/favicon.ico" />

  <!-- RSS -->
  <!-- <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> -->
</head>
  <!-- TODO: Add theme color variable -->
  <body>
    <!-- http://tholman.com/github-corners/ -->
      <a href="https://github.com/timothycrosley/blog" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

<div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      <h1>
        <a href="https://timothycrosley.com">
          Timothy Crosley
        </a>
      </h1>
      <p class="lead">Software Engineer and Open Source Enthusiast. Creator of <a href="https://github.com/timothycrosley/isort">isort</a>, <a href="https://github.com/hugapi/hug">Hug</a>, <a href="https://github.com/timothycrosley/concentration">Concentration</a>, and many other Python tools and libraries.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="https://timothycrosley.com">Home</a>
    </nav>

    <div class="sidebar-social">
        <a class="sidebar-social-item" href="https://github.com/timothycrosley" target="_blank">
          <i class="fab fa-lg fa-github"></i>
        </a>
        <a class="sidebar-social-item" href="https://twitter.com/timothycrosley" target="_blank">
          <i class="fab fa-lg fa-twitter"></i>
        </a>
        <a class="sidebar-social-item" href="https://www.linkedin.com/in/timothycrosley/" target="_blank">
          <i class="fab fa-lg fa-linkedin"></i>
        </a>
        <a class="sidebar-social-item" href="https://www.reddit.com/user/timothycrosley" target="_blank">
          <i class="fab fa-lg fa-reddit"></i>
        </a>
        <a class="sidebar-social-item" href="https://news.ycombinator.com/user?id=timothycrosley" target="_blank">
          <i class="fab fa-lg fa-hacker-news"></i>
        </a>
        <a class="sidebar-social-item" href="https://pypi.org/user/timothycrosley/" target="_blank">
          <i class="fab fa-lg fa-python"></i>
        </a>
        <a class="sidebar-social-item" href="https://gitter.im/timothycrosley" target="_blank">
          <i class="fab fa-lg fa-gitter"></i>
        </a>
        <a class="sidebar-social-item" href="https://www.youtube.com/user/timothycrosley/videos" target="_blank">
          <i class="fab fa-lg fa-youtube"></i>
        </a>
    </div>

    <div class="sidebar-newsletter">
        <p>Subscribe to <a href="https://tinyletter.com/timothycrosley" target="_blank">The latest from Timothy Crosley</a> for updates on upcoming projects and new blog posts.</p>
      <p>Or, follow along via <a href="/feeds/all.rss.xml">RSS</a>/<a href="/feeds/all.atom.xml">Atom</a> feeds.</p>
    </div>

    <div class="sidebar-copyright">
      <p>&copy; <a href="mailto:timothy.crosley@gmail.com">Timothy Edmund Crosley</a> 2020.</p>
    </div>
  </div>
</div>
    <div class="content container">
<div class="post">
  <h1 class="post-title">Project  1/52: preconvert - Supercharge Your Serialization!</h1>
    <span class="post-date">18 August 2019 &middot; 4 min read</span>
  <p><a href="https://timothycrosley.github.io/preconvert/"><img alt="preconvert Logo" src="https://raw.githubusercontent.com/timothycrosley/preconvert/master/art/logo_large.png"></a></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Project:</td>
<td>1/52</td>
</tr>
<tr>
<td>Title/Link:</td>
<td><a href="https://timothycrosley.github.io/preconvert/">preconvert</a></td>
</tr>
<tr>
<td>Pitch:</td>
<td>No more <code>is not JSON serializable</code> errors</td>
</tr>
<tr>
<td>Read if:</td>
<td>You use JSON, MessagePack, BSON, or similar. Or, you are interested in the state of developing Python projects.</td>
</tr>
<tr>
<td>Skip if:</td>
<td>You don't use serialization, only use it with basic built-in types, or only use it from the context of a framework that handles it well already.</td>
</tr>
<tr>
<td>Prior Work:</td>
<td><a href="https://hynek.me/articles/serialization/">https://hynek.me/articles/serialization/</a>, <a href="https://pypi.org/project/json-default/">json-defaults</a>, and probably many more.</td>
</tr>
</tbody>
</table>
<h1>What Problem Does preconvert Solve?</h1>
<p>My first project is a small one that comes the way of a goods friends request made at OSCON.
Many of us use Python's built-in <code>json</code> module or one of the similar serialization libraries available on PyPI.
These are trivially easy to use, and generally, work great. You pass in your native Python objects to <code>json.dumps</code> and your done:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="s2">&quot;preconvert&quot;</span><span class="p">})</span>
</pre></div>


<p>They even tend to follow the same loose specification (a <code>dumps</code> and corresponding <code>loads</code> method) making switching between them
for any reason equally straight forward.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>

<span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="s2">&quot;preconvert&quot;</span><span class="p">})</span>
</pre></div>


<p>This is pretty awesome! It's made even more so by the years of optimization these JSON libraries have received.
Not only is outputting JSON easy, but it's also fast.</p>
<p>Problems occur when you start going beyond the basic built-in types.
Search for <code>is not JSON serializable</code> and countless stack-overflow questions will appear with many workarounds for the problem.
The simplest of which is to override the <code>default</code> callback method provided by handling just the type that failed:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">uuid1</span>


<span class="k">def</span> <span class="nf">fallback_conversion</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="n">UUID</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>


<span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">uuid1</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">fallback_conversion</span><span class="p">)</span>
</pre></div>


<p>The above works great when you have one type you need to convert, and one place where you serialize data.
It works particularly badly if you are serializing data which you don't necessarily have full control of in multiple places.
Many web frameworks, including <a href="http://www.hug.rest/">hug</a>, provide mechanisms to get around this. They allow you to extend JSON serialization cleanly and provide built-in default serialization for most common types.</p>
<p>My friend, Brandon, suggested this shouldn't be hidden within the walls of a framework. Everywhere <code>json</code>, or another serializer is used, it should be trivial
to expand with custom types and handle common ones right out of the gate. I agreed, and preconvert was born.</p>
<h1>What's the Proposed Solution?</h1>
<p><a href="https://timothycrosley.github.io/preconvert/">preconvert</a> is a small, framework independent, extendable Python library that aims to solve the above problems by:</p>
<ol>
<li>
<p>Providing an easy way to specify custom type serializers</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">preconvert</span>

<span class="nd">@preconvert.always</span><span class="p">(</span><span class="n">UUID</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">convert_UUID_to_str</span><span class="p">(</span><span class="n">uuid_instance</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid_instance</span><span class="p">)</span>
</pre></div>


</li>
<li>
<p>Using this ability to automatically handle common types (UUID, dataclasses, etc)</p>
</li>
<li>Adding an easy mechanism to extend this further using entrypoint powered plugins</li>
<li>Exposing the same interface defined by existing serializers to make preconvert an easy drop-in replacement.<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">preconvert.output</span> <span class="kn">import</span> <span class="n">simplejson</span> <span class="k">as</span> <span class="n">json</span>
</pre></div>


</li>
</ol>
<p>preconvert currently works out-of-the-box with <code>bson</code>, <code>json</code>, <code>simplejson</code>, and <code>msgpack</code>.
Currently, there is one <a href="https://github.com/timothycrosley/preconvert_numpy">plugin to handle numpy types</a>, that can be enabled simply by adding it to the projects
package requirements.</p>
<div class="highlight"><pre><span></span><span class="o">`</span><span class="n">pip</span> <span class="n">install</span> <span class="n">preconvert_numpy</span><span class="o">`</span>
</pre></div>


<p>For more information about the project, browse the <a href="https://timothycrosley.github.io/preconvert/">documentation website</a>.</p>
<h1>State of Python Project Creation</h1>
<p>One of the reasons I wanted to challenge myself to create 52 projects over this next year was because I genuinely believe it shouldn't be hard to create projects.
While Python makes many things easy, it's surprising the number of things that should be considered for even a simple project.</p>
<h2>Documentation</h2>
<p>For this project I used both <a href="https://pdoc3.github.io/pdoc/">pdoc3</a> and <a href="https://www.mkdocs.org/">mkdocs</a> for the first time.
<a href="https://pdoc3.github.io/pdoc/">pdoc3</a> is probably the easiest route to document a Python project and I appreciated how it encouraged
me to write more expressive doc strings and better organize my project.
<a href="https://www.mkdocs.org/">mkdocs</a> on the other hand has beautiful templates, integrates very well with the existing Markdown documentation I tend to include in GitHub repos,
and has built in search capabilities. However, mkdocs noticeably lacks any auto-documentation abilities at the current time.
To get around this, I created a build step that included customized <a href="https://pdoc3.github.io/pdoc/">pdoc3</a> output that was compatible with what is expected by mkdocs.
I think it works fairly well, but I was disappointed with the lack of a robust all-in-one solution for simple projects.</p>
<h2>Local Environment Management</h2>
<p>I gave <a href="https://docs.pipenv.org/en/latest/">PipEnv</a> its first serious try. It worked alright, but I found it surprisingly slow.
It often was slow enough to make up for any time benefit it could have provided. I also found <code>pipenv run</code> and <code>pipenv shell</code> clunky to use.
Finally, I found it's lockfile to be confused when I switched machines constantly, my best guess is because of wheels for different platforms. Still, I'm glad to see project environment management become an increased area of focus.
For my next project, I intend to give <a href="https://poetry.eustace.io/">poetry</a> a try.</p>
<h2>Packaging</h2>
<p>I found <a href="https://github.com/takluyver/flit">flit</a> to be an absolute joy to use. For the most part, it just worked and got out of my way.
It's simplified approach is perfect for small projects. The only downside I encountered, which unfortunately for me is a major one, is the lack of <a href="https://cython.org/">Cython</a> support.</p>
<h2>Static Analysis</h2>
<p>I'm a huge fan of static analysis, code formatters, and any tool that aims to raise the bar for code-quality on a project automatically.
This project included <a href="https://github.com/hugapi/HOPE/blob/master/all/HOPE-8--Style-Guide-for-Hug-Code.md#automated-code-cleaners">all the ones I've used in the past</a>, but also, <a href="http://mypy-lang.org/">mypy</a>. For the most part, it just worked.
As someone who is very comfortable with dynamically typed languages, I was surprised how little it impacted my productivity, and how even in this
small project it found real errors.</p>
<p>I'm hoping to make my next projects ones that simplify these steps if only to give me more time to devote to each individual project.</p>
<h1>Thanks For Reading</h1>
<p>Thanks for taking the time to read about this new project!
What do you think of preconvert? Any projects you would like to see in the future? Any projects I should try out?</p>
<p>~Timothy Crosley</p>
</div>


<div class="comments">
  <h2>Comments!</h2>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'timothycrosley-com';
    var disqus_identifier = 'project-1-preconvert';
    var disqus_url = 'https://timothycrosley.com/project-1-preconvert';
    (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//timothycrosley-com.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the comments.</noscript>
</div>
    </div>

<script type="text/javascript">
    var disqus_shortname = 'timothycrosley-com';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

  </body>
</html>